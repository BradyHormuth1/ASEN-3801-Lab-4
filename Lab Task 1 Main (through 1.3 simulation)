% -------------------------------------------------------------------------
% Lab Task 1.3 — Constant-Velocity Trim @ 5 m/s East (psi = 0 deg)
% Derives trim analytically (with inertial gravity model) and simulates once.
% -------------------------------------------------------------------------

%% Parameters
m  = 0.068;                 % kg
d  = 0.060;                 % m (arm)
km = 0.0024;                % N·m per N
Ix = 5.8e-5; 
Iy = 7.2e-5; 
Iz = 1.0e-4; 
I = [Ix; Iy; Iz];
g  = 9.81;                  % m/s^2

% Aero coefficients (must match your EOM)
nu = 1.2e-3;                % translational quad-drag coeff [N/(m/s)^2]
mu = 1.0e-6;                % rotational damping coeff [N·m/(rad/s)^2]

% Desired constant inertial velocity (ENU)
Ux = 0.0;  Uy = 5.0;  Uz = 0.0;      % m/s
psi_trim  = 0.0;                     % rad
phi_trim  = 0.0;                     % rad

%% Mapping [Zc; Lc; Mc; Nc] = M * U
M = [ -1, -1, -1, -1; ...
      -d/sqrt(2), -d/sqrt(2),  d/sqrt(2),  d/sqrt(2); ...
       d/sqrt(2), -d/sqrt(2), -d/sqrt(2),  d/sqrt(2); ...
       km,        -km,         km,        -km       ];

%% Analytic trim solve
Fdrag_x = nu * Ux * abs(Ux);      % magnitude (quadratic), acts opposite to +x
theta_trim = -atan( Fdrag_x / (m*g) );   % nose-down to produce +x thrust

Zc_trim = - m * g / cos(theta_trim);    % thrust magnitude along body +z
Lc_trim = 0; 
Mc_trim = 0; Nc_trim = 0;

% Rotor forces (least-squares in case of numerical tiny mismatch)
controls_trim = [Zc_trim; Lc_trim; Mc_trim; Nc_trim];
U_trim = M \ controls_trim;            % 4x1 rotor forces (N)
U_trim = max(U_trim, 0);               % clamp (physical)

%% Initial state at trim
x0 = 0; y0 = 0; z0 = 0;
phi0 = phi_trim; theta0 = theta_trim; psi0 = psi_trim;
uE0 = Ux; vE0 = Uy; wE0 = Uz;
p0 = 0; q0 = 0; r0 = 0;
var0 = [x0 y0 z0 phi0 theta0 psi0 uE0 vE0 wE0 p0 q0 r0]';

%% One simulation (10 s) with constant U_trim
tspan = [0 10];
ode   = @(t,var) QuadrotorEOM(t, var, g, m, I, d, km, nu, mu, U_trim);
opts  = odeset('RelTol',1e-8,'AbsTol',1e-10);
[t, Y] = ode45(ode, tspan, var0, opts);

% Build arrays for PlotAircraftSim
aircraft_state_array = Y.';                           % 12 x N
control_input_array  = M * repmat(U_trim, 1, numel(t));  % 4 x N

%% Quick checks
dx = Y(end,1) - Y(1,1);
dy = Y(end,2) - Y(1,2);
dz = Y(end,3) - Y(1,3);
Ux_mean = mean(Y(:,7)); Uy_mean = mean(Y(:,8)); Uz_mean = mean(Y(:,9));

fprintf('\n--- Constant-Velocity Trim (5 m/s East) ---\n');
fprintf('theta_trim = %.6f rad (%.3f deg)\n', theta_trim, rad2deg(theta_trim));
fprintf('Zc_trim    = %.6f N   (total thrust = %.6f N)\n', Zc_trim, -Zc_trim);
fprintf('Rotor forces (N): [%.4f %.4f %.4f %.4f]\n', U_trim(1), U_trim(2), U_trim(3), U_trim(4));
fprintf('Mean inertial velocities over run [u v w] = [%.4f %.4f %.4f] m/s\n', Ux_mean, Uy_mean, Uz_mean);
fprintf('Net displacement over %.1f s: dx=%.3f m, dy=%.3f m, dz=%.3f m\n', t(end)-t(1), dx, dy, dz);

%% Plot 
fig = [1 2 3 4 5 6];
col = 'r-';
if exist('PlotAircraftSim','file') == 2
    PlotAircraftSim(t(:), aircraft_state_array, control_input_array, fig, col);
else
    figure(fig(1)); subplot(3,1,1); plot(t, Y(:,1), col); grid on; ylabel('x_E [m]'); title('Position (quick look)');
                      subplot(3,1,2); plot(t, Y(:,2), col); grid on; ylabel('y_E [m]');
                      subplot(3,1,3); plot(t, Y(:,3), col); grid on; ylabel('z_E [m]'); xlabel('t [s]');
    figure(fig(2)); subplot(3,1,1); plot(t, rad2deg(Y(:,4)), col); grid on; ylabel('\phi [deg]'); title('Euler angles (quick look)');
                      subplot(3,1,2); plot(t, rad2deg(Y(:,5)), col); grid on; ylabel('\theta [deg]');
                      subplot(3,1,3); plot(t, rad2deg(Y(:,6)), col); grid on; ylabel('\psi [deg]'); xlabel('t [s]');
end
